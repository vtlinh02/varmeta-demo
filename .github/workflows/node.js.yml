# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  pull_request:
    branches: [ "main" ]
    types: [closed]
jobs:
  handle-commit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    outputs:
      commit-output: ${{steps.handle-commit.outputs.commit_output}}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install dependency
      run: |
        npm install -g pnpm
        pnpm install
        npm install -g ts-node
    - name: test program working?
      run: npm run crawl --silent
      if: github.event.pull_request.merged == true
    - name: Run commit handling
      id: handle-commit
      run: | 
        ts_output=$(npm run crawl --silent)  
        echo "commit-output=${ts_output}" >> $GITHUB_OUTPUT
      shell: bash
      if: github.event.pull_request.merged == true

  send-rest-api:
    needs: handle-commit
    runs-on: ubuntu-latest
    steps:
    - name: Test output exist
      env:
        output: ${{needs.handle-commit.outputs.commit-output}}
      run: |
        echo ${{needs.handle-commit.outputs.commit-output}}
        echo "${{needs.handle-commit.outputs.commit-output}}"
        echo ${output}
        echo $output
        echo "Output is ${output}"
    # - name: Test curl exist
    #   env:
    #     output: Hello
    #   run: |
    #     curl --version
    #     echo "https://2e6c-42-119-180-122.ngrok-free.app/api/v1/crawl?dataRaw=$output"
    # - name: Output of previous step
    #   env:
    #     commit-output: ${{needs.handle-commit.outputs.commit-output}}
    #   run: curl "https://2e6c-42-119-180-122.ngrok-free.app/api/v1/crawl?dataRaw=${commit-output}"
    #   if: github.event.pull_request.merged == true
